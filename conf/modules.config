/*
 * Define modules options
 */

process {

  // Default
  publishDir = [
    path: { "${params.outDir}/${task.process.tokenize(':')[-1].tokenize('_')[0]}" },
    mode: 'copy',
    saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
  ]

  withName:'bwaMem' {
    publishDir = [
      [
        path: { "${params.outDir}/mapping" },
	mode: 'copy',
	pattern: "*.bam",
	enabled: params.saveAlignedIntermediates
      ],
      [
        path: { "${params.outDir}/mapping/logs" },
	mode: 'copy',
	pattern: "*.log"
      ]
    ]
    // ext.args = params.bwaOptions ?: ''
    ext.args = {[
        params.bwaOptions ?: '',
        "-R \"@RG\\tID:${meta.id}\\tPU:${meta.id}\\tSM:${meta.name}\\tLB:${meta.name}\\tPL:illumina\""
    ].join(' ').trim() }
    }

  withName: 'preseq' {
    publishDir = [
      path: { "${params.outDir}/preprocessing/metrics/preseq" },
      mode: 'copy',
      pattern: '*.bai'
    ]
    ext.args = '-e 500e+06'
  }


  withName: 'samtoolsIndex' {
    publishDir = [
      path: { "${params.outDir}/mapping" },
      mode: 'copy',
      pattern: '*.bai'
    ]
  }

  withName:'sambambaMarkdup' {
    publishDir = [
      [
        path: { "${params.outDir}/preprocessing/bams/markDuplicates" },
        mode: 'copy',
        pattern: "*markDups.bam",
        enabled: params.saveAlignedIntermediates
      ],
      [
        path: { "${params.outDir}/preprocessing/bams/markDuplicates/stats" },
        mode: 'copy',
        pattern: '*md.flagstats'
      ]
    ]
  }

  withName:'bamOnTarget' {
    publishDir = [
      [
        path: { "${params.outDir}/preprocessing/bams/onTarget" },
        mode: 'copy',
        pattern: "*_onTarget.bam",
        enabled: params.saveAlignedIntermediates
      ],
      [
        path: { "${params.outDir}/preprocessing/bams/onTarget/stats" },
        mode: 'copy',
        pattern: '*_onTarget.flagstats'
      ]
    ]
  }

  withName: 'samtoolsFilter' {
    publishDir = [
        path: { "${params.filteredBamDir}" },
        mode: 'copy',
        pattern: "*filtered.bam",
        enabled: params.saveAlignedIntermediates
        ]
    ext.args = [
      params.keepDups ? "" : "-F 0x0400",
      params.mapQual > 0 ? "-q ${params.mapQual}" : "",
      params.keepSingleton ? "-F 0x004 -F 0x008 -f 0x001" : "-F 0x004",
      // TODO: utiliser meta.singleEnd
      params.singleEnd ? "-F 0x001" : "",
      params.keepMultiHits ? "-F 0x100 -F 0x800" : ""
    ].join(' ').trim()
  }

  withName: 'samtoolsFlagstat' {
    publishDir = [
      path: {"${params.filteredBamDir}/stats"},
      mode: 'copy',
      saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
    ]
  }

  withName: 'samtoolsIdxstats' {
  publishDir = [
    path: {"${params.filteredBamDir}/stats"},
    mode: 'copy',
    saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
    ]
  }

  withName: 'samtoolsStats' {
    publishDir = [
      path: {"${params.filteredBamDir}/stats"},
      mode: 'copy',
      saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
    ]
  }

  withName:'outputDocumentation' {
    publishDir = [
      path: { "${params.summaryDir}" },
      mode: 'copy'
    ]
  }
}
